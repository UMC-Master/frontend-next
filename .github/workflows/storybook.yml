name: 'Storybook Deployment to Chromatic'

on:
  # Pull Requestê°€ ì—´ë¦¬ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**/*.stories.@(js|jsx|mjs|ts|tsx)'

  # main ë˜ëŠ” develop ë¸Œëœì¹˜ì— Pushë  ë•Œ ì‹¤í–‰
  push:
    branches: [main, develop]
    paths:
      - 'src/**/*.stories.@(js|jsx|mjs|ts|tsx)'

  # ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  storybook-deployment-chromatic:
    runs-on: ubuntu-latest
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì „ì²´ íˆìŠ¤í† ë¦¬ í¬í•¨)
      - name: Checkout To Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Chromaticì´ ë² ì´ìŠ¤ë¼ì¸ì„ ì°¾ê¸° ìœ„í•´ ì „ì²´ Git íˆìŠ¤í† ë¦¬ í•„ìš”

      # pnpm ì„¤ì¹˜ ë° ì„¤ì •
      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v4
        with:
          version: 8

      # Node.js ì„¤ì • (pnpm ìºì‹œ ì‚¬ìš©)
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: pnpm ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      # Chromatic ë°°í¬ (ë‚´ë¶€ì ìœ¼ë¡œ Storybook ë¹Œë“œë¥¼ í¬í•¨)
      - name: Chromatic ë°°í¬
        id: publish_chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          buildScriptName: build-storybook
          onlyChanged: true # ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ í…ŒìŠ¤íŠ¸í•˜ì—¬ íš¨ìœ¨ì„± ì¦ëŒ€

      # íƒ€ì„ì¡´ ë³€í™˜ (ì„ íƒ ì‚¬í•­)
      - name: UTC to KST ë³€í™˜
        id: convert_utc_to_kst
        run: |
          TS="${{ github.event.head_commit.timestamp }}"
          KST=$(date -d "$TS +9 hours" +"%Y-%m-%d %H:%M:%S")
          echo "kst_time=$KST" >> $GITHUB_OUTPUT

      # Pull Requestì— Storybook ë°°í¬ ê²°ê³¼ ì½”ë©˜íŠ¸
      - name: Commentì— Chromatic URL ê¸°ë¡
        if: ${{ github.event_name == 'pull_request' }}
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ github.event.pull_request.number }}
          message: |
            ### ğŸ¨ Storybook Deployed

            ğŸ“¦ PR #${{ github.event.pull_request.number }} by **${{ github.actor }}**
            ğŸ“… KST: `${{ steps.convert_utc_to_kst.outputs.kst_time }}`

            #### ğŸ”— Links
            **[ğŸ“– Storybook Review](${{ steps.publish_chromatic.outputs.storybookUrl }})**

            ---
            *Powered by Chromatic* âœ¨
          comment-tag: 'storybook_deployment_comment'
          mode: 'upsert'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Push ì´ë²¤íŠ¸ ê²°ê³¼ ìš”ì•½ (ë¡œê·¸ìš©)
      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "âœ… Push deployment to ${{ github.ref_name }} branch completed."
          echo "ğŸ¨ Storybook URL: ${{ steps.publish_chromatic.outputs.storybookUrl }}"
