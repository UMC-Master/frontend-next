name: Gemini PR Review (Korean)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Gate (skip for draft/main/develop/fork)
        id: gate
        run: |
          if [[ "${{ github.event.pull_request.draft }}" == "true" || "${{ github.event.pull_request.head.repo.fork }}" == "true" ]]; then
            echo "SKIP=true" >> $GITHUB_OUTPUT
          else
            echo "SKIP=false" >> $GITHUB_OUTPUT
          fi

      - name: Review with Gemini
        if: steps.gate.outputs.SKIP == 'false'
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            const files = await github.rest.pulls.listFiles({ owner, repo, pull_number: pr.number, per_page: 100 });
            const diffs = files.data
              .filter(f => !!f.patch && ['modified','added','removed','renamed'].includes(f.status))
              .map(f => `### ${f.filename}\n\`\`\`diff\n${f.patch}\n\`\`\``);

            if (diffs.length === 0) {
              core.info('No textual diffs to review.');
              return;
            }

            const MAX_CHARS = 20000;
            let merged = '';
            for (const d of diffs) {
              if ((merged + '\n\n' + d).length > MAX_CHARS) break;
              merged += '\n\n' + d;
            }

            const systemKo = `\
ë‹¹ì‹ ì€ HomeMaster íŒ€ì˜ ì‹œë‹ˆì–´ ì—”ì§€ë‹ˆì–´ìž…ë‹ˆë‹¤.
ì•„ëž˜ PR diffë¥¼ í•œêµ­ì–´ë¡œ ë¦¬ë·°í•˜ì„¸ìš”.
- ì¼ë°˜ì ì¸ ì¹­ì°¬/ìš”ì•½ ê¸ˆì§€, êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì§€ì ë§Œ ë²ˆí˜¸ë¡œ ì œì‹œ
- ë²„ê·¸/ë³´ì•ˆ/ì„±ëŠ¥/ì ‘ê·¼ì„±/ìŠ¤íƒ€ì¼/ë¹„ìš© ê´€ì  í¬í•¨
- ê°€ëŠ¥í•˜ë©´ ìµœì†Œ ìˆ˜ì • ì œì•ˆ(\`\`\`suggestion ì½”ë“œë¸”ë¡\`\`\`) ì œê³µ
- ë§¥ë½ì´ ë¶€ì¡±í•˜ë©´ ëª…ì‹œì ìœ¼ë¡œ ê°€ì • ì „ì œ ê¸°ìž¬
- íŒ€ ê°€ì´ë“œ ìš”ì•½:
  - ì»´í¬ë„ŒíŠ¸: PascalCaseFileName.tsx, Hook: useXxx.ts, ìœ í‹¸: kebab-case
  - type/interface/enumì€ PascalCase, enum ê°’/ìƒìˆ˜ëŠ” CAPITAL_SNAKE_CASE
  - ê°™ì€ sliceëŠ” ìƒëŒ€ê²½ë¡œ, ìƒìœ„â†’í•˜ìœ„ import ìµœëŒ€ 2 depth
  - ì´ë¯¸ì§€ webp ì‚¬ìš©, Storybook/ESLint/Prettier ì¤€ìˆ˜
`;

            const userKo = `\
Repo: ${owner}/${repo}
PR #${pr.number} by @${pr.user.login}
ë‹¤ìŒì€ unified diffìž…ë‹ˆë‹¤:
${merged}
`;

            const fetch = global.fetch || (await import('node-fetch')).default;
            const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=' + process.env.GEMINI_API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ role: 'user', parts: [{ text: `${systemKo}\n\n---\n\n${userKo}` }]}],
                generationConfig: { temperature: 0.2 }
              })
            });

            if (!res.ok) {
              const body = await res.text();
              core.setFailed(`Gemini API error: ${res.status} ${body}`);
              return;
            }
            const data = await res.json();
            const text = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join('\n') || 'ë¦¬ë·° ê²°ê³¼ê°€ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤.';

            const marker = '<!-- gemini-review-bot-kr -->';
            const body = `${marker}\n## ðŸ¤– Gemini Review (ko-KR)\n${text}`;

            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: pr.number, per_page: 100 });
            const mine = comments.data.find(c => c.body?.includes(marker) && c.user?.type === 'Bot');

            if (mine) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: mine.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });
            }
